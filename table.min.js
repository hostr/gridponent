"use strict";var tp=tp||{};tp.ChangeMonitor=function(n,t,i,r){var u=this;this.model=i;this.beforeSync=null;this.afterSync=r;this.elem=n;this.listener=function(n){u.syncModel(n.target,u.model);u.afterSync(n,i)};tp.on(n,"change",t,this.listener)};tp.ChangeMonitor.prototype={syncModel:function(n,t){var i=n.name,r=n.value;if(typeof this.beforeSync!="function"||!this.beforeSync(i,r,this.model)){type=tp.getType(t[i]);switch(type){case"number":t[i]=parseFloat(r);break;case"boolean":t[i]=r.toLowerCase()=="true";break;default:t[i]=r}}},stop:function(){tp.off(this.elem,"change",this.listener)}};tp.ComponentBase=Object.create(HTMLElement.prototype);tp.ComponentBase.initialize=function(){return this.config=tp.getConfig(this),this};tp.ComponentBase.createdCallback=function(){this.initialize()},function(){var n,t,i,r;tp.hasValue=function(n){return typeof n!="undefined"&&n!==null};n=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];t=["January","February","March","April","May","June","July","August","September","October","November","December"];tp.formatDate=function(i,r){var u=i,s,o,h;typeof u=="string"&&(s=/^[012][0-9]{3}-[01][0-9]-[0123][0-9]T/,s.test(u)?u=new Date(u):(o=/-?\d+/.exec(u),o!=null&&(h=new Date(parseInt(o[0])).toUTCString().replace("UTC",""),u=new Date(h))));switch(r){case"d":r="M/d/yyyy";break;case"D":r="dddd, MMMM d, yyyy";break;case"t":r="h:mm tt";break;case"T":r="h:mm:ss tt"}var c=u.getFullYear(),e=u.getMonth()+1,l=u.getDate(),f=u.getHours(),a=u.getMinutes(),v=u.getSeconds(),p=u.getMilliseconds(),y=u.getDay();return r.replace("yyyy",c).replace("yy",c.toString().right(2)).replace("ss",v.toString().padLeft(2,"0")).replace("s",v).replace("f",p).replace("mm",a.toString().padLeft(2,"0")).replace("m",a).replace("HH",f.toString().padLeft(2,"0")).replace("H",f).replace("hh",(f>12?f-12:f).toString().padLeft(2,"0")).replace("h",f>12?f-12:f).replace("tt",f>11?">>":"<<").replace("t",f>11?"##":"$$").replace("MMMM","!!").replace("MMM","@@").replace("MM",e.toString().padLeft(2,"0")).replace("M",e).replace("dddd","^^").replace("ddd","&&").replace("dd",l.toString().padLeft(2,"0")).replace("d",l).replace(">>","PM").replace("<<","AM").replace("##","P").replace("$$","A").replace("!!",t[e-1]).replace("@@",t[e-1].substring(0,3)).replace("^^",n[y]).replace("&&",n[y].substring(0,3))};i=[/&/g,/</g,/>/g,/"/g,/'/g,/`/g];r=["&amp;","&lt;","&gt;","&quot;","&apos;","&#96;"];tp.escapeHTML=function(n){if(typeof n!="string")return n;for(var t=0;t<tp.chars.length;t++)n=n.replace(tp.chars[t],tp.scaped[t]);return n};tp.camelize=function(n){return n.replace(/(?:^|[-_])(\w)/g,function(n,t){return t?t.toUpperCase():""})};tp.getConfig=function(n){for(var r={},u,t,f=n.attributes,i=f.length-1;i>=0;i--)t=f[i],u=tp.camelize(t.name),r[u]=t.value==="true"||t.value==="false"?t.value==="true":t.value;return r};tp.getType=function(n){if(n===null)return null;if(n instanceof Date)return"date";if(Array.isArray(n))return"array";if(typeof n=="string")if(/^[012][0-9]{3}-[01][0-9]-[0123][0-9]T/.test(n))return"date";return typeof n};tp.convertType=function(n){switch(n){case"Byte":case"SByte":case"Int32":case"UInt32":case"Int16":case"UInt16":case"Int64":case"UInt64":case"Single":case"Double":case"Decimal":return"Number";case"DateTime":return"Date";case"Boolean":return"Boolean";default:return"String"}};tp.on=function(n,t,i,r){var u,f,e;(typeof n=="string"&&(n=document.querySelector(n)),tp.hasValue(n))&&(u=function(t){for(var u=t.target,e=n.querySelectorAll(i),f;u;){for(f=0;f<e.length;f++)if(u==e[f]){r.call(u,t);return}u=u.parentElement}},n.addEventListener(t,u,!1),f="tp-listeners-"+t,e=n[f]||(n[f]=[]),e.push({pub:r,priv:u}))};tp.off=function(n,t,i){var u=n["tp-listeners-"+t],r;if(u)for(r=0;r<u.length;r++)if(u[r].pub===i){n.removeEventListener(t,u[r].priv);u.splice(r,1);return}};tp.closest=function(n,t){var i,u,r;if(typeof n=="string"&&(n=document.querySelector(n)),n)for(i=n.parentElement,u=document.querySelectorAll(t);i;){for(r=0;r<u.length;r++)if(i==u[r])return i;i=i.parentElement}};tp.hasValue=function(n){return n!==undefined&&n!==null};tp.isNullOrEmpty=function(n){return tp.hasValue(n)===!1||n.length&&n.length===0};tp.copyObj=function(n){var t,r=tp.getType(n),i;switch(r){case"object":t={};i=Object.getOwnPropertyNames(n);i.forEach(function(i){t[i]=n[i]});break;case"array":t=[];n.forEach(function(n,i){t[i]=n});break;default:t=n}return t};tp.resolveObjectPath=function(n){var t,u,i,f;try{for(t=window,u=n.split("."),i=0;i<u.length&&t;i++){var e=u[i],r=e.split("["),o=r[0];t=t[o];t&&r.length>1&&(f=r[1].substring(0,r[1].indexOf("]")-1),t=t[f])}return t}catch(s){console.log("Could not resolve object path: "+n);console.log(s)}}}();tp.Http=function(){};tp.Http.prototype={serialize:function(n,t){var r=this,i;return t=t||Object.getOwnPropertyNames(n),i=[],t.forEach(function(t){i.push(encodeURIComponent(t)+"="+encodeURIComponent(n[t]))}),i.join("&")},createXhr:function(n,t,i,r){var u=new XMLHttpRequest;return u.open(n.toUpperCase(),t,!0),u.setRequestHeader("X-Requested-With","XMLHttpRequest"),u.onload=function(){i(JSON.parse(u.responseText),u)},u.onerror=r,u},get:function(n,t,i){var r=this.createXhr("GET",n,t,i);r.send()},post:function(n,t,i,r){var f=this.serialize(t),u=this.createXhr("POST",n,i,r);u.setRequestHeader("Content-Type","application/x-www-form-urlencoded");u.send(f)}};tp.ServerPager=function(n){this.config=n;this.baseUrl=n.Read};tp.ServerPager.prototype={get:function(n,t,i){var e=this,r=new tp.Http,u=this.baseUrl+"?"+r.serialize(n.data,["Page","Top","OrderBy","Desc","Search","Skip"]),f=function(n){t(n)};r.get(u,f,i)},copyProps:function(n,t){var i=Object.getOwnPropertyNames(n);i.forEach(function(i){t[i]=n[i]})}};tp.ClientPager=function(n){this.data=n.data.Data};tp.ClientPager.prototype={getSkip:function(n){var t=n;if(t.PageCount==0)return 0;if(t.Page<1)t.Page=1;else if(t.Page>t.PageCount)return t.Page=t.PageCount;return(t.Page-1)*t.Top},get:function(n,t){var f=this.getSkip(n),e,i=gryst.from(this.data),r,u;tp.isNullOrEmpty(n.Search)===!1&&(r=gryst.from(n.Columns).where(function(n){return n!==undefined}).select("Field").run(),u=n.Search.toLowerCase(),i=i.where(function(n){for(var t=0;t<r.length;t++)if(n[r[t]]&&n[r[t]].toString().toLowerCase().indexOf(u)!==-1)return!0;return!1}));tp.isNullOrEmpty(n.OrderBy)===!1&&(i=n.Desc?i.orderByDescending(n.OrderBy):i.orderBy(n.OrderBy));e=i.run().length;i=i.skip(f).take(n.Top);n.Data=i.run();t(n)}};tp.PagingModel=function(n){var t=this;this.Top=25;this.PageIndex=0;this.Types={};this.Page=1;this.OrderBy="";this.Desc=!1;this.Search="";this.TotalRows=n.length;this.Data=n;Object.defineProperty(t,"PageCount",{get:function(){return Math.ceil(t.TotalRows/t.Top)}});Object.defineProperty(t,"Skip",{get:function(){if(t.PageCount===0)return 0;if(t.Page<1)t.Page=1;else if(t.Page>t.PageCount)return t.Page=t.PageCount;return t.PageIndex*t.Top}})},function(){var n;tp.helpers={};n=function(n,t){tp.helpers[n]=t};n("toolbarTemplate",function(){var n=[];return this.ToolbarTemplate&&(template=tp.resolveObjectPath(this.ToolbarTemplate),typeof template=="function"?n.push(template(this)):(template=document.querySelector(this.ToolbarTemplate),template&&n.push(template.innerHTML))),new Handlebars.SafeString(n.join(""))});n("colgroup",function(){var n=[],t=(100/this.Columns.length).toString()+"%";return n.push("<colgroup>"),this.Columns.forEach(function(i){n.push('<col style="width:'+(i.Width||t)+'" />')}),n.push("<\/colgroup>"),new Handlebars.SafeString(n.join(""))});n("thead",function(){var t=this,n=[];return n.push("<thead>"),n.push("<tr>"),this.Columns.forEach(function(i){var r=(i.Type||"").toLowerCase();n.push('<td class="'+r+'">');hasValue(i.Commands)===!1&&(i.Sort||t.Sorting)?(n.push('<label class="table-sort">'),n.push('<input type="radio" value="'+(i.Sort||i.Field)+'" name="OrderBy" />'),n.push(i.Header||i.Field),n.push("<\/label>")):n.push(i.Header||i.Field);n.push("<\/th>")}),n.push("<\/tr>"),n.push("<\/thead>"),new Handlebars.SafeString(n.join(""))});n("template",function(n,t){var i=Handlebars.templates[n],r;if(i)return this.arg=t,r=i(this),new Handlebars.SafeString(r)});n("headerCell",function(){var n=[],t=(this.Type||"").toLowerCase();return n.push('<th class="'+t+'">'),n.push(this.Header||this.Field),n.push("<\/th>"),new Handlebars.SafeString(n.join(""))});n("bodyCell",function(n){var i,f,r=n[this.Field],u=(this.Type||"").toLowerCase(),t=[];return t.push('<td class="body-cell '+u+'">'),this.Template?(i=tp.resolveObjectPath(this.Template),typeof i=="function"?t.push(i(this,n)):(i=document.querySelector(this.Template),i&&t.push(i.innerHTML))):hasValue(r)&&(u==="boolean"?r===!0&&t.push('<span class="glyphicon glyphicon-ok"><\/span>'):u==="date"?(f=this.Format||"M/d/yyyy",t.push(formatDate(r,f))):t.push(r)),t.push("<\/td>"),new Handlebars.SafeString(t.join(""))});n("editCell",function(n){var i,t=[],r=n[this.Field]||"";if(t.push('<td class="body-cell">'),this.EditTemplate)i=tp.resolveObjectPath(this.EditTemplate),typeof i=="function"?t.push(i(this,n)):(i=document.querySelector(this.EditTemplate),i&&t.push(i.innerHTML));else{tp.getType(r)==="date"&&(r=formatDate(r,"yyyy-MM-dd"));t.push('<input class="form-control" name="'+this.Field+'" value="'+tp.escapeHTML(r)+'" type="');switch(this.Type){case"Date":t.push("date");break;case"Number":t.push("number");break;default:t.push("text")}t.push('" />')}return t.push("<\/td>"),new Handlebars.SafeString(t.join(""))});n("footerCell",function(n){if(console.log("footerCell: this:"),console.log(this),console.log("footerCell: options:"),console.log(n),typeof this.FooterTemplate=="function"){var t=[],i=n.data.root.data.Data;return t.push(this.FooterTemplate(i,this)),new Handlebars.SafeString(t.join(""))}});n("tablePager",function(){var n=this.data,t=Handlebars.templates["tp-table-pager"],i=t(n);return new Handlebars.SafeString(i)});n("setPagerFlags",function(){this.IsFirstPage=this.Page===1;this.IsLastPage=this.Page===this.PageCount;this.HasPages=this.PageCount>1;this.PreviousPage=this.Page-1;this.NextPage=this.Page+1});var t=Function.prototype,i=t.bind?t.bind.bind(t.call):function(n){return function(t){return function(){return n.apply(t,arguments)}}}(t.call),r={},u=i("".slice),f=i(0..toString),e=function(){var t=!0,n;n:while(t)if(t=!1,n=u(f(Math.random(),36),2),n in r){t=!0;n=undefined;continue n}else return r[n]=n};n("uid",function(){var n=e();return new Handlebars.SafeString(n)})}();tp.Table=Object.create(tp.ComponentBase);tp.Table.initialize=function(){var i=this,n,r,t;for(tp.ComponentBase.initialize.call(this),this.config.Columns=[],this.config.data={},n=0;n<this.children.length;n++)r=this.children[n],t=tp.getConfig(r),this.config.Columns.push(t),this.resolveCommands(t),this.resolveFooterTemplate(t);this.config.Footer=this.resolveFooter(this.config);this.resolveOnCreated();console.log(this.config);this.config.Oncreated&&(this.config.data=this.config.Oncreated(),this.resolveTypes(this.config));this.pager=this.getPager(this.config);this.resolveFirstPage(this.config,this.pager,function(){i.render(i.config)});this.resolveToolbar(this.config);this.beginMonitor();this.addCommandHandlers()};tp.Table.resolveToolbar=function(n){n.Toolbar=n.Toolbar||n.Search||n.ToolbarTemplate};tp.Table.resolveFooter=function(n){for(var t=0;t<n.Columns.length;t++)if(n.Columns[t].FooterTemplate)return!0;return!1};tp.Table.resolveFooterTemplate=function(n){n.FooterTemplate&&(n.FooterTemplate=tp.resolveObjectPath(n.FooterTemplate))};tp.Table.resolveOnCreated=function(){this.config.Oncreated&&(this.config.Oncreated=tp.resolveObjectPath(this.config.Oncreated))};tp.Table.resolveCommands=function(n){n.Commands&&(n.Commands=n.Commands.split(","))};tp.Table.resolveTypes=function(n){n.Columns.forEach(function(t){for(var i=0;i<n.data.length;i++)if(data[i][t.Field]!==null){t.Type=typeof data[i][t.Field];break}})};tp.Table.getPager=function(n){if(n.Paging)return tp.hasValue(n.Read)?new tp.ServerPager(n):new tp.ClientPager(n)};tp.Table.resolveFirstPage=function(n,t,i){t===undefined?i(n.data):t.get(n.data,i)};tp.Table.beginMonitor=function(){var n=this,t=new tp.ChangeMonitor(this,".table-toolbar [name=Search], thead input, .table-pager input",this.config.data,function(){var i,t;for(n.update(),i=n.querySelectorAll("thead input[type=radio], .table-pager input[type=radio]"),t=0;t<i.length;t++)i[t].checked=!1});t.beforeSync=function(n,t,i){return n==="OrderBy"?(i[n]===t?i.Desc=!i.Desc:(i[n]=t,i.Desc=!1),!0):!1}};tp.Table.render=function(n){var t=tp.templates["tp-table"];this.innerHTML=t(n)};tp.Table.refresh=function(n){var i=tp.templates["tp-table-rows"],r=tp.templates["tp-table-pager"],t=i(n);this.querySelector(".table-body > table > tbody").innerHTML=t;t=r(n.data);this.querySelector(".table-pager").innerHTML=t};tp.Table.update=function(){var n=this;this.pager&&this.pager.get(this.config.data,function(t){n.config.data=t;n.refresh(n.config)})};tp.Table.addCommandHandlers=function(){var n=this;tp.on(this,"click","button[value]",function(){var r=this.attributes.value.value.toLowerCase(),t=tp.closest(this,"tr[data-index]"),u=parseInt(t.attributes["data-index"].value),i=n.config.arg=n.config.data.Data[u];switch(r){case"edit":n.editRow(i,t);break;case"delete":n.deleteRow(i,t);break;case"update":n.updateRow(i,t);break;case"cancel":n.cancelEdit(i,t);break;default:console.log("Unrecognized command: "+r)}})};tp.Table.editRow=function(n,t){var i=tp.templates["tp-table-edit-cells"],r=i(this.config);t.innerHTML=r;t["tp-change-monitor"]=new tp.ChangeMonitor(t,"[name]",n,function(){})};tp.Table.updateRow=function(n,t){var r=this,u=new tp.Http,f=this.config.Update,i;u.post(f,n,function(){var n=tp.templates["tp-table-cells"],u=n(r.config);t.innerHTML=u;i=t["tp-change-monitor"];i&&(i.stop(),i=null)})};tp.Table.cancelEdit=function(n,t){var i=tp.templates["tp-table-cells"],r=i(this.config);t.innerHTML=r};tp.Table.deleteRow=function(n){var t=this,i=new tp.Http,r=this.config.Destroy;i.post(r,n,function(){var i=t.config.data.Data.indexOf(n);i!=-1&&(t.config.data.Data.splice(i,1),t.refresh())})};tp.Table.fixDates=function(n,t){var i,r=Object.getOwnPropertyNames(t);r.forEach(function(r){i=tp.convertType(t[r]);i==="Date"&&n.forEach(function(n){tp.isNullOrEmpty(n[r])||(n[r]=new Date(n[r]))})})};document.registerElement("tp-table",{prototype:tp.Table});